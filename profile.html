<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operative Profile | JARVIS</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/animations.css">
    <style>
        .profile-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .avatar-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #00ff88);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #000;
            border: 2px solid #fff;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }

        .admin-badge {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            letter-spacing: 2px;
            display: none;
            /* Show if admin */
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        .profile-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-glass);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>

    <!-- Firebase Compat Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <nav class="nav-container">
        <div class="logo">
            <span style="font-size: 28px;">âšª</span> JARVIS
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="community.html">Community</a>
            <a href="mobile.html">Mobile App</a>
            <a href="profile.html" class="active">Profile</a>
        </div>
    </nav>

    <div class="container fade-in">
        <div class="glass-panel profile-form">
            <div class="profile-header">
                <div class="avatar-circle" id="user-avatar">?</div>
                <h2 class="text-gradient" id="display-name">Loading...</h2>
                <div id="admin-badge" class="admin-badge">COMMANDER ACCESS GRANTED</div>
                <p id="user-email" style="color: var(--text-glass); font-size: 14px; margin-top: 10px;">...</p>
            </div>

            <form id="profile-edit-form">
                <div class="form-group">
                    <label class="form-label">Codename (Display Name)</label>
                    <input type="text" id="edit-name" class="input-field" placeholder="Enter name">
                </div>

                <div class="form-group">
                    <label class="form-label">Secure Line (Phone)</label>
                    <input type="tel" id="edit-phone" class="input-field" placeholder="+91 XXXXX XXXXX">
                </div>

                <div class="form-group">
                    <label class="form-label">Clearance Level</label>
                    <input type="text" id="read-role" class="input-field" value="OPERATIVE" disabled
                        style="background: rgba(255,255,255,0.05); color: var(--text-glass); cursor: not-allowed;">
                </div>

                <button type="submit" class="btn-primary" style="width: 100%; margin-bottom: 15px;">UPDATE
                    PROFILE</button>
            </form>

            <!-- NEW: Initialize System Button -->
            <a href="index.html" class="btn-primary"
                style="display: block; width: 100%; text-align: center; margin-bottom: 20px; background: #00ff88; color: #000; border-color: #00ff88; font-weight: bold; box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);">
                INITIALIZE SYSTEM
            </a>

            <a href="admin.html" id="admin-dashboard-btn" class="btn-primary"
                style="display: none; width: 100%; text-align: center; border-color: #ff4444; color: #ff4444; margin-bottom: 15px;">
                ACCESS COMMAND CENTER
            </a>

            <button onclick="window.authService.logout()" class="btn-primary"
                style="width: 100%; background: rgba(255,68,68,0.1); border-color: transparent; color: #ff4444;">
                SIGN OUT
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
        // Enforce Protocol
        window.authService.enforceProtocol();

        // Load & Populate Data
        const initProfile = setInterval(() => {
            if (window.auth && window.auth.currentUser) {
                clearInterval(initProfile);
                loadProfileData(window.auth.currentUser);
            }
        }, 200);

        async function loadProfileData(user) {
            // Get detailed data from Firestore
            let userData = {};
            try {
                const doc = await window.db.collection("users").doc(user.uid).get();
                if (doc.exists) userData = doc.data();
            } catch (e) { console.error(e); }

            // Populate UI
            const displayName = userData.name || user.displayName || "Unknown Operative";
            const email = userData.email || user.email;
            const phone = userData.phone || "";
            const role = userData.role || "operative";
            const isAdmin = role === 'admin' || sessionStorage.getItem('jarvis_admin');

            document.getElementById('display-name').textContent = displayName.toUpperCase();
            document.getElementById('user-email').textContent = email;
            document.getElementById('user-avatar').textContent = displayName.charAt(0).toUpperCase();

            // Form Inputs
            document.getElementById('edit-name').value = displayName;
            document.getElementById('edit-phone').value = phone;
            document.getElementById('read-role').value = role.toUpperCase();

            // Admin Visuals
            if (isAdmin) {
                document.getElementById('admin-badge').style.display = 'inline-block';
                document.getElementById('admin-dashboard-btn').style.display = 'block';
                document.getElementById('read-role').style.color = '#ff4444';
            }
        }

        // Save Profile
        document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = "SAVING...";
            btn.disabled = true;

            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const uid = window.auth.currentUser.uid;

            try {
                await window.authService.updateProfile(uid, {
                    name: name,
                    phone: phone
                });
                alert("Profile Updated Successfully.");

                // Update header immediately
                document.getElementById('display-name').textContent = name.toUpperCase();
                document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();

            } catch (err) {
                alert("Update Failed: " + err.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>